{% extends 'layout.html.twig' %}
{% block title %}Storage{% endblock %}
{% block header_breadcrumb %}Storage{% endblock %}
{% block header_title %}Storage {{ assetStorage.name }} ({{ assetStorage.description }}){% endblock %}
{% block body_content %}
    <h4>Located at: {{ assetStorage.location }}</h4>
    <div class="row">
        {{ storageRender|raw }}
    </div>
    <div class="container-fluid">
        <p class="text-right">
            {% for counts in storageCounts %}
                 <strong>{{ counts.collected }}</strong> / {{ counts.total }}
            {% endfor %}
        </p>
    </div>
    {% set assignedSlots = [] %}
    {% set assignedSlotsInfo = [] %}
    {% for collectedAsset in collectedAssets %}
        {% set assignedSlots = assignedSlots|merge([collectedAsset.slot]) %}
        {% set assignedSlotsInfo = assignedSlotsInfo|merge([{
            user: collectedAsset.user,
            slot: collectedAsset.slot,
            asset: collectedAsset.asset,
            note: collectedAsset.note,
            checkedOut: collectedAsset.checkedOut,
            processed: collectedAsset.processed
        }]) %}
    {% endfor %}
    <div class="js-assignedSlots" data-assignedSlots="{{ assignedSlots|json_encode }}"></div>
    <div class="js-assignedSlotsInfo" data-assignedSlotsInfo="{{ assignedSlotsInfo|json_encode }}"></div>

    {# View Asset Modal #}
    <div class="modal fade" id="modal-checkin">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-body">
                    {{ form_start(form) }}
                    <input id="assignAssetId" type="hidden" name="assetId" value=""/>
                    <div class="modal-header">
                        <h4 class="modal-title">Assign User</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body pl-2">
                        <div class="row">Asset: <span id="asset">{{ form_widget(form.device) }}</span></div>
                        <div class="row">Assigned User: <span id="assignedUser">{{ form_widget(form.user, { 'attr': {'style': 'width:260px'}}) }}</span></div>
                        <div class="row">Collection Location: <span id="assetCollectionLocation">{{ form_widget(form.location) }}</span></div>
                        <div class="row">Note: <span id="assetCollectionNotes">{{ form_widget(form.notes) }}</span></div>
                        <div class="row">
                            <div class="btn-group">
                                <div class="btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary">
                                     {{ form_widget(form.needsrepair) }} Needs Repair
                                    </label>
                                </div>
                                <div class="btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary">
                                     {{ form_widget(form.checkout) }} Check Out
                                    </label>
                                </div>
                                <div class="btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-secondary">
                                     {{ form_widget(form.processed) }} Processed
                                    </label>
                                </div>
                            </div>
                        </div>
                        {{ form_widget(form.userId) }}
                        {{ form_widget(form.assetId) }}
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        {{ form_widget(form.Collect, {'label': 'Update'}) }}
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
    {# ./viewAssetModal #}
{% endblock %}

{% block head_custom_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .cellOccupied {
            background-color: {{ colors.cellOccupied }}
        }
        
        .cellCheckedOut {
            background-color: {{ colors.cellCheckedOut }}
        }
        
        .cellProcessed {
            background-color: {{ colors.cellProcessed }};
        }
    </style>
{% endblock %}
{% block head_custom_javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        // Set the checkIn Modal
        $("#modal-checkin").on("show.bs.modal", function(e) {
            let storageSlot = $(e.relatedTarget).attr("data-slot");
            let asset = $(e.relatedTarget).attr("data-asset") ?? '';
            let assignedUserId = $(e.relatedTarget).attr("data-user") ?? null;
            let note = $(e.relatedTarget).attr("data-note") ?? '';

            document.getElementById("asset_collection_device").setAttribute("value", asset);
            document.getElementById("asset_collection_notes").innerText = note;
            $("#asset_collection_user").val(assignedUserId).trigger("change");
            document.getElementById("asset_collection_userId").setAttribute("value", assignedUserId);
            document.getElementById("asset_collection_location").setAttribute("value", storageSlot);
        });

        $("#modal-checkin").on("hide.bs.modal", function(e) {
            document.getElementById("asset_collection_userId").removeAttribute("value");
        });

        // Start select2
        $("#asset_collection_user").select2();

        // Populate cells that are assigned
        const assignedSlots = JSON.parse($(".js-assignedSlots").attr("data-assignedSlots"));
        const assignedSlotsInfo = JSON.parse($(".js-assignedSlotsInfo").attr("data-assignedSlotsInfo"));

        $("div[id='row']").children('.col').each(function() {
            if (assignedSlots.includes($(this).attr('id').replace('slot-', ''))) {
                $(this).addClass('cellOccupied');
                var i;
                for (i = 0; i < assignedSlotsInfo.length; ++i) {
                    if (assignedSlotsInfo[i]['slot'] === $(this).attr('id').replace('slot-', '')) {
                        if (assignedSlotsInfo[i]['checkedOut']) {
                            $("#asset_collection_checkout").attr('checked', 'checked');
                            $(this).addClass('cellCheckedOut')
                        }
                        if (assignedSlotsInfo[i]['processed']) {
                            $("#asset_collection_processed").attr('checked', 'checked');
                            $(this).addClass('cellProcessed')
                        }
                    }
                }
                $(this).children('a').each(function() {
                    // $(this).parent().addClass('cellProcessed');
                    for (i = 0; i < assignedSlotsInfo.length; ++i) {
                        if (assignedSlotsInfo[i]['slot'] === $(this).attr('data-slot')) {
                            $(this).attr('data-asset', assignedSlotsInfo[i]['asset']);
                            $(this).attr('data-user', assignedSlotsInfo[i]['user']);
                            $(this).attr('data-note', assignedSlotsInfo[i]['note']);
                            $(this).attr('data-checkedout', assignedSlotsInfo[i]['checkedout']);
                            $(this).attr('data-processed', assignedSlotsInfo[i]['processed']);
                        }
                    }
                })
            }
        });
    });
</script>
{% endblock %}
{% block optional_javascript %}{% endblock %}