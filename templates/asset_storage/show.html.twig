{% extends 'layout.html.twig' %}
{% block title %}Storage{% endblock %}
{% block header_breadcrumb %}Storage{% endblock %}
{% block header_title %}Storage {{ asset_storage.name }} ({{ asset_storage.description }}){% endblock %}
{% block body_content %}
    <h4>Located at: {{ asset_storage.location }}</h4>
    {{ storage_render|raw }}
    {% set assignedSlots = [] %}
    {% set assignedSlotsInfo = [] %}
    {% for collectedAsset in collectedAssets %}
        {% set assignedSlots = assignedSlots|merge([collectedAsset.slot]) %}
        {% set assignedSlotsInfo = assignedSlotsInfo|merge([{user: collectedAsset.user, slot: collectedAsset.slot, asset: collectedAsset.asset, note: collectedAsset.note}]) %}
    {% endfor %}
    <div class="js-assignedSlots" data-assignedSlots="{{ assignedSlots|json_encode }}"></div>
    <div class="js-assignedSlotsInfo" data-assignedSlotsInfo="{{ assignedSlotsInfo|json_encode }}"></div>

    {# View Asset Modal #}
    <div class="modal fade" id="modal-checkin">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-body">
                    {{ form_start(form) }}
                    <input id="assignAssetId" type="hidden" name="assetId" value=""/>
                    <div class="modal-header">
                        <h4 class="modal-title">Assign User</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body pl-2">
                        <div class="row">Asset: <span id="asset">{{ form_widget(form.device) }}</span></div>
                        <div class="row">Assigned User: <span id="assignedUser">{{ form_widget(form.user, { 'attr': {'style': 'width:260px'}}) }}</span></div>
                        <div class="row">Collection Location: <span id="assetCollectionLocation">{{ form_widget(form.location) }}</span></div>
                        <div class="row">Note: <span id="assetCollectionNotes">{{ form_widget(form.notes) }}</span></div>
                        <div class="row">
                            <div class="btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-secondary">
                                 {{ form_widget(form.needsrepair) }} Needs Repair
                                </label>
                            </div>
                        </div>
                        {{ form_widget(form.userId) }}
                        {{ form_widget(form.assetId) }}
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        {{ form_widget(form.Collect) }}
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
    {# ./viewAssetModal #}
{% endblock %}

{% block head_custom_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block head_custom_javascript %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        // Set the checkIn Modal
        $("#modal-checkin").on("show.bs.modal", function(e) {
            let storageSlot = $(e.relatedTarget).attr("data-slot");
            // let assetId = $(e.relatedTarget).attr("data-assetId");
            let asset = $(e.relatedTarget).attr("data-asset") ?? '';
            let assignedUserId = $(e.relatedTarget).attr("data-user") ?? null;
            let note = $(e.relatedTarget).attr("data-note") ?? '';

            document.getElementById("asset_collection_device").setAttribute("value", asset);
            document.getElementById("asset_collection_notes").innerText = note;
            // document.getElementById("asset_collection_assetId").setAttribute("value", assetId);
            $("#asset_collection_user").val(assignedUserId).trigger("change");
            document.getElementById("asset_collection_userId").setAttribute("value", assignedUserId);
            document.getElementById("asset_collection_location").setAttribute("value", storageSlot);
        });

        $("#modal-checkin").on("hide.bs.modal", function(e) {
            document.getElementById("asset_collection_userId").removeAttribute("value");
        });

        // Start select2
        $("#asset_collection_user").select2();

        // Populate cells that are assigned
        const assignedSlots = JSON.parse($(".js-assignedSlots").attr("data-assignedSlots"));
        const assignedSlotsInfo = JSON.parse($(".js-assignedSlotsInfo").attr("data-assignedSlotsInfo"));

        $("div[id='row']").children('.col').each(function() {
            if (assignedSlots.includes($(this).attr('id').replace('slot-', ''))) {
                $(this).addClass('bg-info');
                $(this).children('a').each(function() {
                    var i;
                    for (i = 0; i < assignedSlotsInfo.length; ++i) {
                        if (assignedSlotsInfo[i]['slot'] === $(this).attr('data-slot')) {
                            $(this).attr('data-asset', assignedSlotsInfo[i]['asset']);
                            $(this).attr('data-user', assignedSlotsInfo[i]['user']);
                            $(this).attr('data-note', assignedSlotsInfo[i]['note']);
                        }
                    }
                })
            }
       });
    });
</script>
{% endblock %}
{% block optional_javascript %}{% endblock %}